name: Build Wheel for Windows

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    # 激活 Visual Studio 环境
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.19
      id: cuda-toolkit
      with:
        cuda: '12.6.0'
        method: 'network'

    - name: Install PyTorch Nightly & Build Deps
      run: |
        python -m pip install --upgrade pip
        pip install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/cu126
        pip install --upgrade setuptools wheel ninja packaging

    - name: Patch for Python 3.13
      shell: powershell
      run: |
        $file = "setup.py"
        if (Test-Path $file) {
            $content = Get-Content $file
            if ($content -match "import imp") {
                $content = $content -replace 'import imp', '# import imp'
                $content | Set-Content $file
                Write-Host "Patched setup.py"
            }
        }

    - name: Build Wheel
      shell: cmd
      env:
        CUDA_HOME: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
        TORCH_CUDA_ARCH_LIST: "9.0" 
        DISTUTILS_USE_SDK: 1
        # [关键修改] 限制只用1个核心编译，防止内存爆炸卡死
        MAX_JOBS: 1
      run: |
        cl.exe
        nvcc --version
        # 这里的 -v 会让你看到它在逐个编译文件，而不是卡着不动
        python setup.py bdist_wheel -v

    - name: Upload Wheel
      if: success() || failure() 
      uses: actions/upload-artifact@v4
      with:
        name: block-sparse-attention-wheel
        path: dist/*.whl
