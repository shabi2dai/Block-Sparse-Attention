name: Build Wheel for Windows

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    # [关键修复步骤] 激活 Visual Studio C++ 编译环境 (cl.exe)
    - name: Setup MSVC (C++ Compiler)
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.19
      id: cuda-toolkit
      with:
        cuda: '12.6.0'
        method: 'network'

    - name: Install PyTorch Nightly & Build Deps
      run: |
        python -m pip install --upgrade pip
        # 安装 PyTorch Nightly
        pip install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/cu126
        # 安装编译依赖 (包含 packaging 修复之前的报错)
        pip install --upgrade setuptools wheel ninja packaging

    - name: Patch for Python 3.13 (Fix 'imp' module error)
      shell: powershell
      run: |
        $file = "setup.py"
        if (Test-Path $file) {
            $content = Get-Content $file
            if ($content -match "import imp") {
                $content = $content -replace 'import imp', '# import imp'
                $content | Set-Content $file
                Write-Host "Patched setup.py: removed 'import imp'"
            }
        }

    - name: Build Wheel
      shell: cmd
      env:
        # 9.0 对应 RTX 4090/H100 (Hopper)，5090 (Blackwell) 兼容运行
        # 显式指定 CUDA 路径，防止找不到
        CUDA_HOME: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
        TORCH_CUDA_ARCH_LIST: "9.0" 
        DISTUTILS_USE_SDK: 1
      run: |
        # 打印一下编译器版本，确信它存在
        cl.exe
        nvcc --version
        python setup.py bdist_wheel -v

    - name: Upload Wheel
      if: success() || failure() 
      uses: actions/upload-artifact@v4
      with:
        name: block-sparse-attention-wheel
        path: dist/*.whl
