name: Build Wheel for Windows

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.19
      id: cuda-toolkit
      with:
        cuda: '12.6.0'
        method: 'network'

    - name: Install PyTorch Nightly & Build Deps
      run: |
        python -m pip install --upgrade pip
        pip install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/cu126
        # 安装 packaging 和 setuptools (最新版 setuptools 会自动处理 distutils 问题)
        pip install --upgrade setuptools wheel ninja packaging

    - name: Patch for Python 3.13 (Fix 'imp' module error)
      shell: powershell
      run: |
        $file = "setup.py"
        if (Test-Path $file) {
            $content = Get-Content $file
            if ($content -match "import imp") {
                $content = $content -replace 'import imp', '# import imp'
                $content | Set-Content $file
                Write-Host "Patched setup.py: removed 'import imp'"
            }
        }

    - name: Build Wheel
      shell: cmd
      env:
        # 9.0 对应 RTX 4090/H100 (Hopper)，5090 (Blackwell) 兼容运行
        TORCH_CUDA_ARCH_LIST: "9.0" 
        DISTUTILS_USE_SDK: 1
      run: |
        python setup.py bdist_wheel -v

    - name: Upload Wheel
      if: success() || failure() 
      uses: actions/upload-artifact@v4
      with:
        name: block-sparse-attention-wheel
        path: dist/*.whl
